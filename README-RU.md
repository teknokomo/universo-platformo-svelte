# Universo Platformo – Svelte

Реализация **Universo Platformo / Universo MMOOMM / Universo Kiberplano** на базе SvelteKit и TypeScript-стека.

## Обзор

Universo Platformo — открытая платформа для создания иммерсивных многомировых переживаний.
Данный репозиторий является **Svelte/SvelteKit**-реализацией и воспроизводит архитектуру
[universo-platformo-react](https://github.com/teknokomo/universo-platformo-react).

Проект организован в виде **PNPM-монорепозитория**, где каждая функция живёт в своём пакете в директории `packages/`.

---

## Технологический стек

| Слой | Технология |
|---|---|
| Frontend-фреймворк | [SvelteKit 2](https://kit.svelte.dev/) (SSR + клиентский роутинг) |
| Язык | TypeScript 5 |
| Менеджер пакетов | PNPM 8 (workspaces) |
| Идентификация / Авт. | [Supabase](https://supabase.com/) (только на стороне сервера) |
| Безопасность сессий | HTTP-only куки, подписанные HMAC-SHA256 |
| Инструмент сборки | Vite 5 |
| Node-адаптер | `@sveltejs/adapter-node` |

> **Принцип безопасности:** браузер **никогда** не обращается к Supabase напрямую.
> Все операции с удостоверением личности проходят через серверную часть SvelteKit.

---

## Структура монорепозитория

```
packages/
├── auth-srv/base/       # Бэкенд-библиотека аутентификации (операции Supabase, подписанные куки)
├── start-srv/base/      # Бэкенд-библиотека стартовой страницы (сервис онбординга)
├── start-frt/base/      # Svelte-библиотека компонентов (лендинг и UI онбординга)
└── app-frt/base/        # Основное SvelteKit-приложение (роуты, хуки, API-эндпоинты)
```

---

## Пакеты

### `@universo/auth-srv`

Серверная библиотека аутентификации. Не привязана к фреймворку; работает с любым Node.js-сервером.

- Вход / Регистрация через Supabase (email + пароль)
- Верификация токена через Supabase Admin API
- Тихое обновление сессии через refresh-токен Supabase
- Куки сессии, подписанные HMAC-SHA256 (целостность без обращений к Supabase)

### `@universo/start-srv`

Бэкенд-библиотека онбординга. Хранит и читает состояние онбординга из метаданных пользователя Supabase.

- `getOnboardingItems(userId)` — возвращает доступные Проекты, Кампании, Кластеры
- `joinItems(userId, data)` — сохраняет выбор и отмечает онбординг как завершённый

### `@universo/start-frt`

Svelte-библиотека компонентов для стартовой страницы.

| Компонент | Описание |
|---|---|
| `StartPage` | Умная обёртка — показывает гостевой или авторизованный вид |
| `GuestStartPage` | Лендинг: hero, отзывы, подвал |
| `AuthenticatedStartPage` | Мастер онбординга или экран завершения |
| `Hero` | Hero-секция «Enter all worlds» с кнопкой призыва к действию |
| `Testimonials` | Сетка из четырёх карточек с отзывами |
| `OnboardingWizard` | Пошаговый мастер (Проекты → Кампании → Кластеры) |
| `CompletionStep` | Показывается, когда онбординг уже завершён |
| `StartFooter` | Подвал с брендингом и ссылками |

### `app-frt`

Основное SvelteKit-приложение. Использует все указанные выше пакеты.

**Страницы**

| Маршрут | Описание |
|---|---|
| `/` | Стартовая страница (гостевая или авторизованная в зависимости от сессии) |
| `/auth` | Страница входа и регистрации (редирект на `/` при наличии сессии) |

**API-маршруты**

| Метод + Путь | Описание |
|---|---|
| `POST /api/auth/login` | Аутентификация по email и паролю; устанавливает куки сессии |
| `POST /api/auth/logout` | Удаление куки сессии |
| `GET /api/auth/me` | Возвращает текущего пользователя из сессии |
| `POST /api/auth/register` | Регистрация нового пользователя |
| `GET /api/auth/csrf` | Эндпоинт CSRF-токена |
| `GET /api/v1/onboarding/items` | Получение элементов онбординга (требует авторизации) |
| `POST /api/v1/onboarding/join` | Сохранение выбора онбординга (требует авторизации) |

---

## Процесс аутентификации

```
Браузер                      Серверная часть SvelteKit       Supabase
   │                                │                            │
   │  POST /api/auth/login          │                            │
   │ ──────────────────────────────>│                            │
   │                                │  signInWithPassword()      │
   │                                │ ──────────────────────────>│
   │                                │<── { user, session }───────│
   │                                │                            │
   │  Set-Cookie: up_session        │                            │
   │  (HMAC-подпись, httpOnly)      │                            │
   │<───────────────────────────────│                            │
   │                                │                            │
   │  GET / (любая страница)        │                            │
   │ ──────────────────────────────>│                            │
   │                                │  проверка HMAC локально    │
   │                                │  (без вызова Supabase)     │
   │<── locals.user заполнен ───────│                            │
```

Куки сессии подписаны **HMAC-SHA256** с использованием `SESSION_SECRET`.
Сервер проверяет подпись локально при каждом запросе — без обращения к Supabase для действительных сессий.
При истечении срока токена сервер пытается выполнить тихое обновление через хранимый refresh-токен.

---

## Начало работы

### Требования

- Node.js ≥ 20
- PNPM ≥ 8 (`npm install -g pnpm`)
- Проект в [Supabase](https://supabase.com/)

### Установка

```bash
# 1. Установка зависимостей
pnpm install

# 2. Настройка окружения
cp .env.example packages/app-frt/base/.env
# Отредактируйте .env и укажите учётные данные Supabase и SESSION_SECRET

# 3. Запуск сервера разработки
pnpm dev
```

Откройте [http://localhost:5173](http://localhost:5173) в браузере.

### Переменные окружения

Скопируйте `.env.example` в `packages/app-frt/base/.env` и заполните значения:

```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
SESSION_SECRET=your-session-secret-min-32-chars
PUBLIC_APP_URL=http://localhost:5173
```

> `SESSION_SECRET` должен содержать **не менее 32 символов**.
> Он используется для подписи куки сессии алгоритмом HMAC-SHA256.

### Сборка для продакшена

```bash
pnpm build
```

---

## Соглашения проекта

- Все пакеты-источники располагаются в `packages/<name>/base/`
- Бэкенд-библиотеки (`*-srv`) — независимый от фреймворка TypeScript
- Фронтенд-библиотеки (`*-frt`) — пакеты Svelte-компонентов
- Пакет `app-frt` является единственным развёртываемым SvelteKit-приложением
- Документация на английском и русском поддерживается параллельно (`README.md` / `README-RU.md`)

---

## Лицензия

Омская открытая лицензия — подробности см. в файлах отдельных пакетов.
