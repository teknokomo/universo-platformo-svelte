# Анализ архитектурных паттернов: миграция с React на Svelte

**Дата**: 2025-11-17  
**Цель**: Документировать архитектурные паттерны, выявленные в репозитории Universo Platformo React, и их адаптацию для реализации на Svelte  
**Исходный репозиторий**: https://github.com/teknokomo/universo-platformo-react (v0.38.0-alpha)

## Резюме

Этот документ анализирует архитектурные паттерны из репозитория Universo Platformo React и определяет паттерны, которые следует принять, адаптировать или избегать в реализации на Svelte. Анализ фокусируется на извлечении лучших архитектурных решений, избегая при этом неполных реализаций и устаревшего кода.

## Ключевые выявленные архитектурные паттерны

### 1. Архитектура общих пакетов

**Паттерн**: Централизованные служебные пакеты, устраняющие дублирование кода между пакетами функций.

**Реализация в React**:
- `@universo/types` - определения типов TypeScript и схемы Zod
- `@universo/utils` - общие утилиты с отдельными сборками для браузера/сервера
- `@universo/api-client` - типобезопасный API-клиент с интеграцией React Query
- `@universo/i18n` - централизованный экземпляр i18next с реестром пространств имён
- `@universo/template-mui` - общие шаблоны компонентов React/MUI

**Адаптация для Svelte**:
✅ **ПРИНЯТЬ**: Все общие пакеты кроме MUI-шаблона
- Создать `@universo/types` с той же структурой
- Создать `@universo/utils` с условными экспортами для браузера/сервера
- Создать `@universo/api-client`, адаптированный для паттернов SvelteKit
- Создать `@universo/i18n` с использованием Svelte-совместимой библиотеки i18n
- Создать эквивалент `@universo/template-svelte` для UI-паттернов

**Преимущества**:
- Устраняет дублирование кода в 20+ пакетах функций
- Обеспечивает согласованность типов между фронтендом и бэкендом
- Упрощает соблюдение контрактов API
- Централизует конфигурацию i18n, предотвращая конфликты множественных экземпляров

### 2. PNPM Catalog для управления зависимостями

**Паттерн**: Централизованные версии зависимостей в секции catalog файла `pnpm-workspace.yaml`.

**Реализация в React**:
```yaml
catalog:
  typescript: ^5.8.3
  i18next: 23.16.8
  react-i18next: ^15.5.3
  vite: ^5.4.19
  zod: ^3.25.76
  # ... 70+ зависимостей
```

**Адаптация для Svelte**:
✅ **ПРИНЯТЬ**: Использовать функцию PNPM catalog
- Адаптировать для зависимостей экосистемы Svelte
- Сохранить версии TypeScript, инструментов сборки и утилит
- Заменить React-специфичные библиотеки на эквиваленты Svelte

**Преимущества**:
- Единый источник истины для версий
- Предотвращает расхождение версий между пакетами
- Упрощает обновление зависимостей
- Снижает нагрузку на поддержку package.json

### 3. Продвинутая конфигурация сборки с tsdown

**Паттерн**: Современный сборщик TypeScript (tsdown) для библиотечных пакетов с двойным выводом ESM/CJS.

**Реализация в React**:
- Отдельный tsdown.config.ts для каждого пакета
- Сборки специфичные для платформы (node vs browser)
- Условные экспорты в package.json
- Управление внешними зависимостями для предотвращения сборки пакетов рабочего пространства

**Пример**:
```typescript
export default defineConfig({
  entry: { index: './src/index.ts' },
  format: ['esm', 'cjs'],
  dts: true,
  platform: 'node',
  exports: false, // Ручное управление экспортами
  external: ['@universo/*', 'react', '@mui/*'],
});
```

**Адаптация для Svelte**:
✅ **ПРИНЯТЬ**: Использовать tsdown для библиотечных пакетов
- Настроить для Svelte вместо React externals
- Использовать Vite для полноценных приложений SvelteKit
- Сохранить двойной вывод ESM/CJS для совместимости

**Преимущества**:
- Быстрые инкрементальные сборки
- Оптимальные размеры бандлов через tree-shaking
- Максимальная совместимость (ESM + CJS)
- Чёткое разделение собранного vs внешнего кода

### 4. Turborepo для оркестрации сборки

**Паттерн**: Turborepo управляет конвейером сборки с кэшированием и параллелизацией.

**Реализация в React**:
```json
{
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**"],
      "cache": false
    },
    "dev": {
      "cache": false,
      "persistent": true
    }
  }
}
```

**Адаптация для Svelte**:
✅ **РАССМОТРЕТЬ**: Опционально, но рекомендуется для производительности сборки
- Та же конфигурация работает для Svelte
- Сокращает время сборки в CI/CD
- Включает параллельную сборку пакетов

**Преимущества**:
- Более быстрые сборки монорепозитория
- Автоматическое упорядочивание зависимостей
- Поддержка удалённого кэширования для CI
- Лучший опыт разработчика

### 5. Условные экспорты пакетов

**Паттерн**: Детальный контроль над экспортами пакетов с использованием условных экспортов Node.js.

**Реализация в React** (из @universo/utils):
```json
{
  "exports": {
    ".": {
      "browser": {
        "import": "./dist/index.browser.mjs",
        "types": "./dist/index.browser.d.ts"
      },
      "import": "./dist/index.mjs",
      "types": "./dist/index.d.ts"
    },
    "./rate-limiting": {
      "import": "./dist/rate-limiting.mjs"
    },
    "./ui-utils": {
      "import": "./dist/ui-utils.mjs"
    }
  }
}
```

**Адаптация для Svelte**:
✅ **ПРИНЯТЬ**: Использовать условные экспорты
- Предотвратить сборку серверного кода в браузер
- Включить tree-shaking неиспользуемых утилит
- Предоставить отдельные точки входа для разных функций

**Преимущества**:
- Меньшие бандлы фронтенда
- Предотвращает случайное попадание серверного кода в браузер
- Лучшая оптимизация tree-shaking
- Чёткие границы API

### 6. Псевдонимы путей TypeScript

**Паттерн**: Согласованные псевдонимы путей во всех пакетах для более чистых импортов.

**Реализация в React**:
```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"],
      "@types/*": ["../../../packages/universo-types/base/src/*"],
      "@utils/*": ["../../../packages/universo-utils/base/src/*"],
      "@components/*": ["src/components/*"]
    }
  }
}
```

**Адаптация для Svelte**:
✅ **ПРИНЯТЬ**: Тот же паттерн с псевдонимами путей SvelteKit
- Настроить в svelte.config.js и tsconfig.json
- Поддерживать согласованность между пакетами

**Преимущества**:
- Более чистые импорты (без ../../../)
- Более лёгкий рефакторинг
- Лучшее автодополнение IDE
- Согласованный стиль импортов

### 7. Паттерн централизации i18n

**Паттерн**: Единый экземпляр i18next с динамической регистрацией пространств имён для избежания конфликтов множественных экземпляров.

**Реализация в React**:
```typescript
// пакет @universo/i18n
export const i18nInstance = i18next.createInstance();
export function registerNamespace(ns: string, resources: Resources) {
  // Динамическая регистрация пространства имён
}
```

**Использование в пакетах функций**:
```typescript
import { i18nInstance, registerNamespace } from '@universo/i18n';
registerNamespace('clusters', { en: clustersEn, ru: clustersRu });
```

**Адаптация для Svelte**:
✅ **ПРИНЯТЬ**: Централизованный i18n с Svelte-совместимой библиотекой
- Использовать svelte-i18n или аналог
- Сохранить паттерн реестра пространств имён
- Поддержка ленивой загрузки

**Преимущества**:
- Предотвращает баги множественных экземпляров i18n
- Включает ленивую загрузку переводов
- Централизует определение языка
- Согласованные паттерны перевода

### 8. API-клиент с типобезопасностью

**Паттерн**: Централизованный API-клиент, соблюдающий типовые контракты между фронтендом и бэкендом.

**Реализация в React**:
```typescript
import { ClusterSchema } from '@universo/types';

export class ClustersClient {
  async getClusters(): Promise<Cluster[]> {
    const response = await this.http.get('/api/clusters');
    return ClusterSchema.array().parse(response.data); // Валидация в рантайме
  }
}
```

**Адаптация для Svelte**:
✅ **ПРИНЯТЬ**: Типобезопасный API-клиент для SvelteKit
- Использовать load-функции SvelteKit или пользовательский клиент
- Сохранить валидацию Zod в рантайме
- Интегрировать с хранилищами SvelteKit для реактивности

**Преимущества**:
- Типобезопасность между фронтендом и бэкендом
- Валидация в рантайме обнаруживает нарушения контракта API
- Единый источник истины для типов API
- Упрощает эволюцию API

## Сравнение структуры пакетов

### Структура репозитория React
```
packages/
├── analytics-frt           # Фронтенд функции аналитики
├── auth-frt                # Фронтенд функции аутентификации
├── auth-srv                # Бэкенд функции аутентификации
├── clusters-frt            # Фронтенд функции кластеров
├── clusters-srv            # Бэкенд функции кластеров
├── metaverses-frt         # Фронтенд функции метавселенных
├── metaverses-srv         # Бэкенд функции метавселенных
├── uniks-frt              # Фронтенд функции уников
├── uniks-srv              # Бэкенд функции уников
├── space-builder-frt      # Фронтенд конструктора пространств
├── space-builder-srv      # Бэкенд конструктора пространств
├── spaces-frt             # Фронтенд функции пространств
├── spaces-srv             # Бэкенд функции пространств
├── profile-frt            # Фронтенд функции профиля
├── profile-srv            # Бэкенд функции профиля
├── publish-frt            # Фронтенд функции публикации
├── publish-srv            # Бэкенд функции публикации
├── multiplayer-colyseus-srv # Сервер мультиплеера (Colyseus)
├── universo-types         # Общие типы
├── universo-utils         # Общие утилиты
├── universo-api-client    # API-клиент
├── universo-i18n          # экземпляр i18n
├── universo-template-mui  # шаблоны MUI
├── universo-rest-docs     # документация API
├── updl                   # система узлов UPDL
└── flowise-*              # устаревшие пакеты Flowise (для удаления)
```

### Структура репозитория Svelte (рекомендуется)
```
packages/
├── auth-frt               # Фронтенд функции аутентификации
├── auth-srv               # Бэкенд функции аутентификации
├── clusters-frt           # Фронтенд функции кластеров
├── clusters-srv           # Бэкенд функции кластеров
├── metaverses-frt        # Фронтенд функции метавселенных
├── metaverses-srv        # Бэкенд функции метавселенных
├── uniks-frt             # Фронтенд функции уников
├── uniks-srv             # Бэкенд функции уников
├── spaces-frt            # Фронтенд функции пространств
├── spaces-srv            # Бэкенд функции пространств
├── profile-frt           # Фронтенд функции профиля
├── profile-srv           # Бэкенд функции профиля
├── universo-types        # Общие типы ✅
├── universo-utils        # Общие утилиты ✅
├── universo-api-client   # API-клиент ✅
├── universo-i18n         # экземпляр i18n ✅
├── universo-template-svelte # UI-шаблоны Svelte ✅
└── core-config           # конфигурация окружения (существующая спецификация)
```

**Примечание**: Продвинутые функции, такие как publish, space-builder, multiplayer, UPDL будут добавлены итеративно на более поздних этапах.

## Паттерны, которых следует избегать

### ❌ Устаревший код из Flowise

**Проблема**: Репозиторий React всё ещё содержит частично переработанные пакеты Flowise:
- `packages/flowise-*` (7 пакетов)
- Смешанные старые и новые паттерны
- Неполная миграция мультипользовательского режима

**Стратегия избежания**:
- НЕ копировать никакие flowise-* пакеты
- Извлекать только архитектурные паттерны (концепция системы узлов)
- Реализовывать функции UPDL и Canvas с нуля при необходимости
- Ссылаться только на целевую архитектуру, а не на устаревшую реализацию

### ❌ Неполная документация

**Проблема**: Репозиторий React имеет несогласованную документацию:
- Некоторые пакеты без README-файлов
- Смешанное соответствие билингвальности
- Неполная документация API

**Стратегия избежания**:
- Следовать строгой билингвальной документации с первого дня
- Создавать README-файлы для всех пакетов немедленно
- Документировать API до реализации

### ❌ Смешанные модульные системы

**Проблема**: Репозиторий React имеет несогласованную конфигурацию модулей:
- Некоторые пакеты используют ESM, некоторые CommonJS
- Несогласованные паттерны tsconfig.json
- Смешанные стили импорта

**Стратегия избежания**:
- Стандартизировать на ESM со слоем совместимости CJS
- Использовать согласованный tsconfig.json во всех пакетах
- Следовать лучшим практикам разрешения модулей Node.js

## Приоритет реализации

### Фаза 1: Основа (начальная настройка)
1. ✅ Структура репозитория и рабочее пространство PNPM
2. ✅ Архитектура общих пакетов:
   - @universo/types
   - @universo/utils
   - @universo/api-client
   - @universo/i18n
3. ✅ Настройка PNPM catalog
4. ✅ Инструменты сборки (tsdown, Vite)
5. ✅ Конфигурация Turborepo (опционально)

### Фаза 2: Основные функции
1. Реализация Auth (auth-frt + auth-srv)
2. Реализация паттерна Clusters (clusters-frt + clusters-srv)
3. Система шаблонов (@universo/template-svelte)

### Фаза 3: Расширенные функции
1. Metaverses (повторное использование паттерна Clusters)
2. Spaces (добавление функциональности canvas)
3. Управление профилем
4. Uniks (расширенная иерархия)

### Фаза 4: Продвинутые функции
1. Space Builder (редактирование canvas)
2. Механизм публикации
3. Мультиплеер (Colyseus или альтернатива)
4. Система узлов UPDL
5. Функциональность экспорта/импорта

## Ключевые различия: React vs Svelte

### Архитектурные сходства (переиспользуемые паттерны)
- ✅ Структура монорепозитория с PNPM
- ✅ Соглашения об именовании пакетов (-frt, -srv, base/)
- ✅ Архитектура общих пакетов
- ✅ Строгий режим TypeScript
- ✅ Интеграция Supabase
- ✅ Аутентификация Passport.js
- ✅ PNPM catalog
- ✅ Двойные сборки ESM/CJS

### Замены технологий
| Версия React | Версия Svelte |
|--------------|---------------|
| React + React Router | SvelteKit (SSR + маршрутизация) |
| React Query | load-функции SvelteKit + stores |
| @mui/material | Svelte Material UI / SMUI |
| react-i18next | svelte-i18n или эквивалент |
| Express (отдельный) | эндпоинты SvelteKit (унифицированные) |
| reactflow | @xyflow/svelte (версия Svelte) |

### Различия инструментов сборки
| Версия React | Версия Svelte |
|--------------|---------------|
| tsdown (библиотеки) | tsdown (библиотеки) ✅ То же |
| Vite (фронтенд) | Vite + SvelteKit ✅ Похоже |
| Turbo (опционально) | Turbo (опционально) ✅ То же |

## Контрольный список валидации

Перед тем, как считать спецификацию завершённой, проверить:

- [x] Все общие пакеты из React документированы для Svelte
- [x] Паттерн PNPM catalog объяснён
- [x] Конфигурация инструментов сборки (tsdown) документирована
- [x] Паттерн условных экспортов описан
- [x] Псевдонимы путей TypeScript указаны
- [x] Паттерн централизации i18n документирован
- [x] Паттерн API-клиента адаптирован для Svelte
- [x] Устаревшие паттерны для избежания чётко помечены
- [x] Приоритет реализации определён
- [x] Замены технологий идентифицированы

## Заключение

Репозиторий Universo Platformo React демонстрирует зрелые архитектурные паттерны, которые следует принять в версии Svelte:

1. **Архитектура общих пакетов** - Критична для повторного использования кода и типобезопасности
2. **PNPM Catalog** - Необходим для управления зависимостями в масштабе
3. **Современные инструменты сборки** - tsdown обеспечивает оптимальные сборки библиотек
4. **Условные экспорты** - Предотвращают раздувание бандла и включают tree-shaking
5. **Централизованный i18n** - Избегает конфликтов множественных экземпляров
6. **Типобезопасный API-клиент** - Обеспечивает соблюдение контрактов между фронтендом и бэкендом

Принимая эти паттерны, избегая при этом устаревшего кода и неполных реализаций, версия Svelte будет иметь прочную архитектурную основу с первого дня.

---

**Следующие шаги**:
1. Обновить спецификацию с требованиями общих пакетов
2. Обновить конституцию при необходимости новых принципов
3. Создать задачи начальной настройки, включая общие пакеты
4. Начать реализацию с Фазы 1 (Основа)
